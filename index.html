<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>音符躲貓貓（4×2 固定排版＋排行榜＋音效）</title>
<style>
  :root{--bg:#fafbff;--ink:#1e1f22;--muted:#667189;--brand:#3b82f6;--ok:#16a34a;--ng:#ef4444;--card:#fff;--cardBd:#d7dbe7;--cardHover:#eef2ff;--chip:#f1f5f9}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,"PingFang TC","Noto Sans TC",sans-serif}
  header,footer{padding:12px 16px;background:#fff}
  header{position:sticky;top:0;border-bottom:1px solid #e5e7f0;z-index:3;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .h1{font-weight:800;font-size:20px}
  .tag{background:var(--chip);border-radius:999px;padding:4px 10px;font-size:12px;color:#445066}
  .grow{flex:1}
  .stat{display:flex;gap:6px;align-items:center}
  .btn{border:1px solid #cfd5e3;background:#fff;border-radius:10px;padding:6px 12px;font-weight:600;cursor:pointer}
  .btn.primary{background:#3b82f6;color:#fff;border-color:#3b82f6}
  .btn.ghost{background:transparent}
  main{padding:16px;max-width:1200px;margin:auto}
  .question{font-weight:700;margin:12px 0}
  /* 固定 4×2 佈局 */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;max-width:960px;margin:20px auto}
  .card{background:#fff;border:2px dashed var(--cardBd);border-radius:12px;padding:10px;cursor:pointer;position:relative;transition:.15s}
  .card:hover{background:var(--cardHover)}
  .card img{width:100%;height:auto;display:block}
  .card.correct{outline:3px solid var(--ok)}
  .card.wrong{outline:3px solid var(--ng)}
  .pill{position:absolute;bottom:8px;right:8px;padding:2px 8px;border-radius:12px;background:#000a;color:#fff;font-size:12px}
  footer{border-top:1px solid #e5e7f0;font-size:12px;text-align:center;color:#555}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:10;padding:16px}
  .modal.show{display:grid}
  .panel{background:#fff;border-radius:16px;padding:20px;max-width:90%;max-height:90vh;overflow:auto}
  .panel h2{margin:0 0 8px}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px dashed #ddd;padding:6px;text-align:left}
  th{background:#f8f8f8}
</style>
</head>
<body>

<header>
  <div class="h1">音符躲貓貓</div>
  <span class="tag">翻對 +10｜翻錯 -5｜找到全部正解即可過關</span>
  <div class="grow"></div>
  <div class="stat"><b>關卡</b> <span id="stage">1 / 10</span></div>
  <div class="stat"><b>分數</b> <span id="score">0</span></div>
  <button id="leaderboardBtn" class="btn">排行榜</button>
  <button id="restart" class="btn ghost">重新開始</button>
</header>

<main>
  <div id="q" class="question"></div>
  <section id="board" class="grid"></section>
</main>

<footer>
  <div>「Pensif」 Kevin MacLeod（incompetech.com）</div>
  <div>根據知識共享許可：署名4.0許可</div>
  <div><a href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</a></div>
</footer>

<!-- 音效檔（與 index.html 放在同一層） -->
<audio id="snd-correct" src="correct.mp3" preload="auto"></audio>
<audio id="snd-wrong"   src="wrong.mp3"   preload="auto"></audio>
<audio id="snd-bgm"     src="bgm.mp3"     preload="auto" loop></audio>

<!-- Modals -->
<div id="introModal" class="modal show"><div class="panel">
  <h2>遊戲說明</h2>
  <p>每關有 8 張牌（4×2），請找出題目指定的音符。翻對 +10 分，翻錯 -5 分。找到全部正解即可過關。</p>
  <button id="startBtn" class="btn primary">開始遊戲</button>
</div></div>

<div id="levelModal" class="modal"><div class="panel">
  <h2>恭喜答對了！</h2>
  <p>已找到本關全部正解，請繼續下一關。</p>
  <button id="nextFromModal" class="btn primary">下一關</button>
</div></div>

<div id="finishModal" class="modal"><div class="panel">
  <h2>恭喜通關！</h2>
  <p>總分：<b id="finalScore">0</b></p>
  <input id="playerName" placeholder="輸入名字（可空白）">
  <button id="saveScoreBtn" class="btn primary">儲存並查看排行榜</button>
</div></div>

<div id="leaderboardModal" class="modal"><div class="panel">
  <h2>排行榜</h2>
  <table><thead><tr><th>#</th><th>名字</th><th>分數</th><th>日期</th></tr></thead><tbody id="lb"></tbody></table>
  <button id="closeLB" class="btn">關閉</button>
</div></div>

<script>
/* === 音效 === */
const sndCorrect=document.getElementById('snd-correct');
const sndWrong=document.getElementById('snd-wrong');
const sndBgm=document.getElementById('snd-bgm');

/* === 你的 10 張牌卡（和 index.html 同一層）=== */
const ASSETS = [
  { id:'do_treble_ledger',   solfege:'Do',  letter:'C', file:'高音譜號下加一線do五線譜.png' },
  { id:'do_bass_ledger',     solfege:'Do',  letter:'C', file:'低音譜號上加一線do五線譜.png' },
  { id:'re_treble_below',    solfege:'Re',  letter:'D', file:'高音譜號下一間re五線譜.png' },
  { id:'mi_treble_line1',    solfege:'Mi',  letter:'E', file:'高音譜號第一線mi五線譜.png' },
  { id:'fa_treble_space1',   solfege:'Fa',  letter:'F', file:'高音譜號第一間fa五線譜.png' },
  { id:'sol_treble_line2',   solfege:'Sol', letter:'G', file:'高音譜號第二線sol五線譜.png' },
  { id:'fa_bass_line4',      solfege:'Fa',  letter:'F', file:'低音譜號第四線fa五線譜.png' },
  { id:'sol_bass_space4',    solfege:'Sol', letter:'G', file:'低音譜號第四間sol五線譜.png' },
  { id:'la_bass_line5',      solfege:'La',  letter:'A', file:'低音譜號第五線la五線譜.png' },
  { id:'si_bass_spaceUp',    solfege:'Si',  letter:'B', file:'低音譜號上加一間si五線譜.png' }
];

/* === 題目 === */
const LEVELS = [
  { prompt:'請找出下列為 Do 的音符。', target:'Do' },
  { prompt:'請找出下列為 F 的音符。',   target:'F'  },
  { prompt:'請找出下列為 Sol 的音符。', target:'Sol' },
  { prompt:'請找出下列為 A 的音符。',   target:'A'  },
  { prompt:'請找出下列為 Si 的音符。',  target:'B'  },
  { prompt:'請找出下列為 D 的音符。',   target:'D'  },
  { prompt:'請找出下列為 Mi 的音符。',  target:'Mi' },
  { prompt:'請找出下列為 Fa 的音符。',  target:'Fa' },
  { prompt:'請找出下列為 La 的音符。',  target:'La' },
  { prompt:'請找出下列為 C 的音符。',   target:'C'  }
];

let level=0,score=0,found=0,targets=[];
const $=s=>document.querySelector(s);
function shuffle(a){return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);}
function isTarget(a,t){return a.solfege.toLowerCase()==t.toLowerCase()||a.letter.toLowerCase()==t.toLowerCase();}

/* === 關卡渲染 === */
function renderLevel(){
  const L=LEVELS[level];
  $('#q').textContent=L.prompt;
  $('#stage').textContent=(level+1)+' / '+LEVELS.length;
  $('#score').textContent=score;
  found=0;

  // 3 張正解 + 5 張干擾 ＝ 8 張（固定 4×2）
  const tAssets=ASSETS.filter(x=>isTarget(x,L.target));
  const deckCorrect=[...tAssets, ...tAssets, ...tAssets].slice(0,3);
  const others=shuffle(ASSETS.filter(x=>!isTarget(x,L.target))).slice(0,5);
  const cards=shuffle([...deckCorrect,...others]);
  targets=cards.filter(c=>isTarget(c,L.target));

  const board=$('#board'); board.innerHTML='';
  cards.forEach(c=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<img src="${c.file}" alt=""><span class="pill">點我</span>`;
    div.onclick=()=>{
      if(div.classList.contains('correct')||div.classList.contains('wrong')) return;
      if(isTarget(c,L.target)){
        div.classList.add('correct'); score+=10; found++;
        try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch(e){}
        if(found>=targets.length){ openModal('levelModal'); }
      }else{
        div.classList.add('wrong'); score=Math.max(0, score-5);
        try{ sndWrong.currentTime=0; sndWrong.play(); }catch(e){}
      }
      $('#score').textContent=score;
    };
    board.appendChild(div);
  });
}

/* === 關卡流程 === */
function nextLevel(){
  level++;
  if(level>=LEVELS.length){
    $('#finalScore').textContent=score;
    openModal('finishModal');
    return;
  }
  renderLevel();
}
$('#restart').onclick=()=>{level=0;score=0;renderLevel();};

function openModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }
document.getElementById('startBtn').onclick=()=>{ closeModal('introModal'); try{ sndBgm.play(); }catch(e){} };
document.getElementById('nextFromModal').onclick=()=>{ closeModal('levelModal'); nextLevel(); };

/* === 排行榜（LocalStorage） === */
const LB_KEY="note.lb.v1";
const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const loadLB=()=>JSON.parse(localStorage.getItem(LB_KEY)||'[]');
const saveLB=l=>localStorage.setItem(LB_KEY,JSON.stringify(l));
function renderLB(){
  const tb=$('#lb'); tb.innerHTML='';
  loadLB().forEach((r,i)=>{ tb.innerHTML+=`<tr><td>${i+1}</td><td>${r.n}</td><td>${r.s}</td><td>${r.d}</td></tr>`; });
}
document.getElementById('saveScoreBtn').onclick=()=>{
  const name=document.getElementById('playerName').value || '匿名';
  const list=loadLB(); list.push({n:name,s:score,d:fmt(new Date())});
  list.sort((a,b)=>b.s-a.s || a.d.localeCompare(b.d)); saveLB(list.slice(0,10));
  closeModal('finishModal'); renderLB(); openModal('leaderboardModal');
};
document.getElementById('leaderboardBtn').onclick=()=>{ renderLB(); openModal('leaderboardModal'); };
document.getElementById('closeLB').onclick=()=>closeModal('leaderboardModal');

/* === 啟動 === */
renderLevel();
</script>
</body>
</html>
