<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>音符躲貓貓</title>
<style>
  :root{
    --bg:#fafbff; --ink:#1e1f22; --muted:#667189; --brand:#3b82f6; --ok:#16a34a; --ng:#ef4444;
    --card:#fff; --cardBd:#d7dbe7; --cardHover:#eef2ff; --chip:#f1f5f9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,"PingFang TC","Noto Sans TC",sans-serif}
  header,footer{padding:14px 20px}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7f0;z-index:3}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .tag{background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px;color:#445066}
  .btn{appearance:none;border:1px solid #cfd5e3;background:#fff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .h1{font-weight:800;font-size:20px}
  .stat{gap:6px}
  .stat b{font-size:15px}
  main{padding:18px 20px 60px;max-width:1200px;margin:auto}
  .question{font-weight:700;margin:8px 0 14px}
  .grid{display:grid;grid-template-columns:repeat(4, minmax(160px,1fr)); gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  .card{background:var(--card);border:2px dashed var(--cardBd);border-radius:16px;padding:12px;cursor:pointer;position:relative;transition:.15s}
  .card:hover{background:var(--cardHover)}
  .card img{width:100%;display:block;border-radius:8px;user-select:none;pointer-events:none}
  .card.correct{outline:3px solid var(--ok)}
  .card.wrong{outline:3px solid var(--ng)}
  .pill{position:absolute;inset:auto 10px 10px auto;padding:2px 8px;border-radius:999px;font-size:12px;background:#00000099;color:#fff}
  .bar{display:flex;align-items:center;gap:10px}
  .vol{display:flex;gap:14px;flex-wrap:wrap}
  .vol .ctl{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#fff;border:1px solid #e5e7f0;border-radius:10px}
  input[type="range"]{accent-color:var(--brand)}
  footer{color:#5b657a;border-top:1px solid #e5e7f0;font-size:12px}
</style>
</head>
<body>

<header class="row">
  <div class="h1">音符躲貓貓</div>
  <span class="tag">翻對 +10｜翻錯 -5｜找到全部正解即可過關</span>
  <div style="flex:1"></div>
  <div class="row stat"><b>關卡</b><span id="stage">1 / 10</span></div>
  <div class="row stat"><b>分數</b><span id="score">0</span></div>
  <button id="restart" class="btn ghost">重新開始</button>
</header>

<main>
  <div class="row vol" style="margin-bottom:10px">
    <div class="ctl"><b>總音量</b><input id="vol-master" type="range" min="0" max="1" step="0.01"></div>
    <div class="ctl"><label><input id="sfx-toggle" type="checkbox"> ✔️ 正確（correct）</label>
      <input id="vol-correct" type="range" min="0" max="1" step="0.01"></div>
    <div class="ctl"><label><input id="wrong-toggle" type="checkbox"> ❌ 錯誤（wrong）</label>
      <input id="vol-wrong" type="range" min="0" max="1" step="0.01"></div>
    <div class="ctl"><label><input id="bgm-toggle" type="checkbox"> 🎵 背景音樂（bgm）</label>
      <input id="vol-bgm" type="range" min="0" max="1" step="0.01"></div>
    <button id="volBtn" class="btn">調整音量</button>
  </div>

  <div id="q" class="question"></div>
  <section id="board" class="grid"></section>
  <div style="margin-top:16px" class="row">
    <button id="next" class="btn primary" disabled>下一關</button>
  </div>
</main>

<footer>
  音樂署名：<br>
  “Pensif” Kevin MacLeod (incompetech.com)<br>
  Licensed under Creative Commons: By Attribution 4.0 License<br>
  http://creativecommons.org/licenses/by/4.0/
</footer>

<!-- 音效/音樂（與 index.html 放同一資料夾） -->
<audio id="snd-correct" preload="auto" src="correct.mp3"></audio>
<audio id="snd-wrong"   preload="auto" src="wrong.mp3"></audio>
<audio id="snd-bgm"     preload="auto" src="bgm.mp3"></audio>

<script>
/*** ========= 資料 =========== ***/
// 所有關卡只使用這 10 張圖片（檔名需與資料夾一致）
const ASSETS = [
  { id:'do_bass_ledger',     solfege:'Do', letter:'C', file:'高音譜號下加一線do五線譜.png' }, // treble ledger Do
  { id:'do_bass_ledger_low', solfege:'Do', letter:'C', file:'低音譜號上加一線do五線譜.png' }, // bass ledger Do
  { id:'re_treble_below',    solfege:'Re', letter:'D', file:'高音譜號下一間re五線譜.png' },
  { id:'mi_treble_line1',    solfege:'Mi', letter:'E', file:'高音譜號第一線mi五線譜.png' },
  { id:'fa_treble_space1',   solfege:'Fa', letter:'F', file:'高音譜號第一間fa五線譜.png' },
  { id:'sol_treble_line2',   solfege:'Sol',letter:'G', file:'高音譜號第二線sol五線譜.png' },
  { id:'fa_bass_line4',      solfege:'Fa', letter:'F', file:'低音譜號第四線fa五線譜.png' },
  { id:'sol_bass_space4',    solfege:'Sol',letter:'G', file:'低音譜號第四間sol五線譜.png' }, // ←已依你要求改檔名
  { id:'la_bass_line5',      solfege:'La', letter:'A', file:'低音譜號第五線la五線譜.png' },
  { id:'si_bass_spaceUp',    solfege:'Si', letter:'B', file:'低音譜號上加一間si五線譜.png' }  // ←已依你要求改檔名
];

// 題目（10 關、固定句子、無混合答案）
const LEVELS = [
  { prompt:'請找出下列為 Do 的音符。', target:'Do' },
  { prompt:'請找出下列為 F 的音符。',   target:'F'  },
  { prompt:'請找出下列為 Sol 的音符。', target:'Sol'},
  { prompt:'請找出下列為 A 的音符。',   target:'A'  },
  { prompt:'請找出下列為 Si 的音符。',  target:'B'  }, // Si = B
  { prompt:'請找出下列為 D 的音符。',   target:'D'  },
  { prompt:'請找出下列為 Mi 的音符。',  target:'Mi' },
  { prompt:'請找出下列為 Fa 的音符。',  target:'Fa' },
  { prompt:'請找出下列為 La 的音符。',  target:'La' },
  { prompt:'請找出下列為 C 的音符。',   target:'C'  }
];

// 每關顯示 8 張卡，其中正解張數
const CARDS_PER_LEVEL = 8;
const CORRECT_NEEDED   = 3;

/*** ========= 工具 =========== ***/
const $ = sel => document.querySelector(sel);
const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);

function isTarget(asset, target){
  // 支援 Solfege（Do Re …）與英文（C D …）
  return asset.solfege.toLowerCase()===target.toLowerCase()
      || asset.letter.toLowerCase() ===target.toLowerCase();
}

/*** ========= 音訊 =========== ***/
const sndCorrect = $('#snd-correct');
const sndWrong   = $('#snd-wrong');
const sndBgm     = $('#snd-bgm');

// Safari/行動裝置需要使用者互動後才能播放
let audioUnlocked = false;
function unlockAudioOnce(){
  if (audioUnlocked) return;
  [sndCorrect,sndWrong,sndBgm].forEach(a=>{
    try { a.muted = true; a.play().then(()=>{a.pause(); a.currentTime=0; a.muted=false;}); } catch(e){}
  });
  audioUnlocked = true;
  // 若 BGM 有開，互動後啟播
  if (state.bgmOn) try{ sndBgm.play(); }catch(e){}
}
document.addEventListener('pointerdown', unlockAudioOnce, { once:true });

/*** ========= 混音器（會記住） =========== ***/
const store = {
  get k(){ return 'notegame.settings.v2'; },
  load(){
    try{ return JSON.parse(localStorage.getItem(this.k))||{} }catch(e){return {}}
  },
  save(obj){ localStorage.setItem(this.k, JSON.stringify(obj)); }
};

const state = Object.assign({
  master: 0.8,
  sfxOn:  true,
  wrongOn:true,
  bgmOn:  true,
  volCorrect: 1,
  volWrong:   1,
  volBgm:     0.35
}, store.load());

function applyVolumes(){
  const m = Number(state.master);
  sndCorrect.volume = m * (state.sfxOn ? Number(state.volCorrect):0);
  sndWrong.volume   = m * (state.wrongOn? Number(state.volWrong)  :0);
  sndBgm.volume     = m * (state.bgmOn  ? Number(state.volBgm)    :0);
  if (state.bgmOn && audioUnlocked) sndBgm.play().catch(()=>{});
  if (!state.bgmOn) sndBgm.pause();
}
function bindMixerUI(){
  const vMaster=$('#vol-master'), vC=$('#vol-correct'), vW=$('#vol-wrong'), vB=$('#vol-bgm');
  const tSfx=$('#sfx-toggle'), tWrong=$('#wrong-toggle'), tBgm=$('#bgm-toggle');

  vMaster.value=state.master; vC.value=state.volCorrect; vW.value=state.volWrong; vB.value=state.volBgm;
  tSfx.checked=state.sfxOn; tWrong.checked=state.wrongOn; tBgm.checked=state.bgmOn;

  const onChange=()=>{
    state.master=Number(vMaster.value);
    state.volCorrect=Number(vC.value);
    state.volWrong=Number(vW.value);
    state.volBgm=Number(vB.value);
    state.sfxOn=tSfx.checked; state.wrongOn=tWrong.checked; state.bgmOn=tBgm.checked;
    store.save(state); applyVolumes();
  };
  [vMaster,vC,vW,vB,tSfx,tWrong,tBgm].forEach(el=>el.addEventListener('input',onChange));
  $('#volBtn').addEventListener('click',onChange);
}
bindMixerUI(); applyVolumes();

/*** ========= 遊戲邏輯 =========== ***/
let levelIndex = 0;
let score = 0;
let found = 0;
let targetsOnBoard = [];

function buildDeck(target){
  // 先挑出所有 target 的圖片
  const targets = ASSETS.filter(a=>isTarget(a,target));
  // 不足 3 張就重複抽到 3
  const need = CORRECT_NEEDED;
  const picksTarget = [];
  while (picksTarget.length < need) {
    picksTarget.push(targets[picksTarget.length % targets.length]);
  }
  // 再補足干擾項
  const others = ASSETS.filter(a=>!isTarget(a,target));
  const distractors = shuffle(others).slice(0, Math.max(0, CARDS_PER_LEVEL - picksTarget.length));
  // 允許再重複，補滿到 8 張
  while (picksTarget.length + distractors.length < CARDS_PER_LEVEL) {
    distractors.push(others[Math.floor(Math.random()*others.length)]);
  }
  const deck = shuffle([...picksTarget, ...distractors]).map((a,i)=>({
    key:`${a.id}-${i}-${Math.random().toString(36).slice(2,6)}`,
    asset:a,
    isCorrect:isTarget(a,target),
    picked:false
  }));
  // 記住本關正解數量
  targetsOnBoard = deck.filter(c=>c.isCorrect);
  return deck;
}

function renderLevel(){
  const L = LEVELS[levelIndex];
  $('#q').textContent = '題目：「' + L.prompt + '」';
  $('#stage').textContent = (levelIndex+1) + ' / ' + LEVELS.length;
  $('#score').textContent = score;
  $('#next').disabled = true;
  found = 0;

  const deck = buildDeck(L.target);
  const board = $('#board');
  board.innerHTML = '';
  deck.forEach(card=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.dataset.key = card.key;
    div.innerHTML = `<img alt="" loading="lazy" src="${card.asset.file}"><span class="pill">點我</span>`;
    div.addEventListener('click', ()=>{
      if (card.picked) return;
      card.picked = true;
      if (card.isCorrect){
        div.classList.add('correct');
        score += 10; found++;
        try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch(e){}
        if (found >= targetsOnBoard.length){ $('#next').disabled = false; }
      }else{
        div.classList.add('wrong');
        score = Math.max(0, score - 5);
        try{ sndWrong.currentTime=0; sndWrong.play(); }catch(e){}
      }
      $('#score').textContent = score;
    });
    board.appendChild(div);
  });
}

$('#next').addEventListener('click', ()=>{
  levelIndex++;
  if (levelIndex >= LEVELS.length){
    alert(`恭喜通關！總分：${score}`);
    levelIndex = 0; score = 0;
  }
  renderLevel();
});
$('#restart').addEventListener('click', ()=>{
  levelIndex = 0; score = 0; renderLevel();
});

// 初始載入
renderLevel();
</script>
</body>
</html>
