<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>éŸ³ç¬¦èº²è²“è²“</title>
<style>
  :root{
    --bg:#fafbff; --ink:#1e1f22; --muted:#667189; --brand:#3b82f6; --ok:#16a34a; --ng:#ef4444;
    --card:#fff; --cardBd:#d7dbe7; --cardHover:#eef2ff; --chip:#f1f5f9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,"PingFang TC","Noto Sans TC",sans-serif}
  header,footer{padding:14px 20px}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7f0;z-index:3}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .tag{background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px;color:#445066}
  .btn{appearance:none;border:1px solid #cfd5e3;background:#fff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .h1{font-weight:800;font-size:20px}
  .stat{gap:6px}
  .stat b{font-size:15px}
  main{padding:18px 20px 60px;max-width:1200px;margin:auto}
  .question{font-weight:700;margin:8px 0 14px}
  .grid{display:grid;grid-template-columns:repeat(4, minmax(160px,1fr)); gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  .card{background:var(--card);border:2px dashed var(--cardBd);border-radius:16px;padding:12px;cursor:pointer;position:relative;transition:.15s}
  .card:hover{background:var(--cardHover)}
  .card img{width:100%;display:block;border-radius:8px;user-select:none;pointer-events:none}
  .card.correct{outline:3px solid var(--ok)}
  .card.wrong{outline:3px solid var(--ng)}
  .pill{position:absolute;inset:auto 10px 10px auto;padding:2px 8px;border-radius:999px;font-size:12px;background:#00000099;color:#fff}
  .bar{display:flex;align-items:center;gap:10px}
  .vol{display:flex;gap:14px;flex-wrap:wrap}
  .vol .ctl{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#fff;border:1px solid #e5e7f0;border-radius:10px}
  input[type="range"]{accent-color:var(--brand)}
  footer{color:#5b657a;border-top:1px solid #e5e7f0;font-size:12px}
</style>
</head>
<body>

<header class="row">
  <div class="h1">éŸ³ç¬¦èº²è²“è²“</div>
  <span class="tag">ç¿»å° +10ï½œç¿»éŒ¯ -5ï½œæ‰¾åˆ°å…¨éƒ¨æ­£è§£å³å¯éé—œ</span>
  <div style="flex:1"></div>
  <div class="row stat"><b>é—œå¡</b><span id="stage">1 / 10</span></div>
  <div class="row stat"><b>åˆ†æ•¸</b><span id="score">0</span></div>
  <button id="restart" class="btn ghost">é‡æ–°é–‹å§‹</button>
</header>

<main>
  <div class="row vol" style="margin-bottom:10px">
    <div class="ctl"><b>ç¸½éŸ³é‡</b><input id="vol-master" type="range" min="0" max="1" step="0.01"></div>
    <div class="ctl"><label><input id="sfx-toggle" type="checkbox"> âœ”ï¸ æ­£ç¢ºï¼ˆcorrectï¼‰</label>
      <input id="vol-correct" type="range" min="0" max="1" step="0.01"></div>
    <div class="ctl"><label><input id="wrong-toggle" type="checkbox"> âŒ éŒ¯èª¤ï¼ˆwrongï¼‰</label>
      <input id="vol-wrong" type="range" min="0" max="1" step="0.01"></div>
    <div class="ctl"><label><input id="bgm-toggle" type="checkbox"> ğŸµ èƒŒæ™¯éŸ³æ¨‚ï¼ˆbgmï¼‰</label>
      <input id="vol-bgm" type="range" min="0" max="1" step="0.01"></div>
    <button id="volBtn" class="btn">èª¿æ•´éŸ³é‡</button>
  </div>

  <div id="q" class="question"></div>
  <section id="board" class="grid"></section>
  <div style="margin-top:16px" class="row">
    <button id="next" class="btn primary" disabled>ä¸‹ä¸€é—œ</button>
  </div>
</main>

<footer>
  éŸ³æ¨‚ç½²åï¼š<br>
  â€œPensifâ€ Kevin MacLeod (incompetech.com)<br>
  Licensed under Creative Commons: By Attribution 4.0 License<br>
  http://creativecommons.org/licenses/by/4.0/
</footer>

<!-- éŸ³æ•ˆ/éŸ³æ¨‚ï¼ˆèˆ‡ index.html æ”¾åŒä¸€è³‡æ–™å¤¾ï¼‰ -->
<audio id="snd-correct" preload="auto" src="correct.mp3"></audio>
<audio id="snd-wrong"   preload="auto" src="wrong.mp3"></audio>
<audio id="snd-bgm"     preload="auto" src="bgm.mp3"></audio>

<script>
/*** ========= è³‡æ–™ =========== ***/
// æ‰€æœ‰é—œå¡åªä½¿ç”¨é€™ 10 å¼µåœ–ç‰‡ï¼ˆæª”åéœ€èˆ‡è³‡æ–™å¤¾ä¸€è‡´ï¼‰
const ASSETS = [
  { id:'do_bass_ledger',     solfege:'Do', letter:'C', file:'é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdoäº”ç·šè­œ.png' }, // treble ledger Do
  { id:'do_bass_ledger_low', solfege:'Do', letter:'C', file:'ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdoäº”ç·šè­œ.png' }, // bass ledger Do
  { id:'re_treble_below',    solfege:'Re', letter:'D', file:'é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“reäº”ç·šè­œ.png' },
  { id:'mi_treble_line1',    solfege:'Mi', letter:'E', file:'é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmiäº”ç·šè­œ.png' },
  { id:'fa_treble_space1',   solfege:'Fa', letter:'F', file:'é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“faäº”ç·šè­œ.png' },
  { id:'sol_treble_line2',   solfege:'Sol',letter:'G', file:'é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsoläº”ç·šè­œ.png' },
  { id:'fa_bass_line4',      solfege:'Fa', letter:'F', file:'ä½éŸ³è­œè™Ÿç¬¬å››ç·šfaäº”ç·šè­œ.png' },
  { id:'sol_bass_space4',    solfege:'Sol',letter:'G', file:'ä½éŸ³è­œè™Ÿç¬¬å››é–“soläº”ç·šè­œ.png' }, // â†å·²ä¾ä½ è¦æ±‚æ”¹æª”å
  { id:'la_bass_line5',      solfege:'La', letter:'A', file:'ä½éŸ³è­œè™Ÿç¬¬äº”ç·šlaäº”ç·šè­œ.png' },
  { id:'si_bass_spaceUp',    solfege:'Si', letter:'B', file:'ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“siäº”ç·šè­œ.png' }  // â†å·²ä¾ä½ è¦æ±‚æ”¹æª”å
];

// é¡Œç›®ï¼ˆ10 é—œã€å›ºå®šå¥å­ã€ç„¡æ··åˆç­”æ¡ˆï¼‰
const LEVELS = [
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º Do çš„éŸ³ç¬¦ã€‚', target:'Do' },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º F çš„éŸ³ç¬¦ã€‚',   target:'F'  },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º Sol çš„éŸ³ç¬¦ã€‚', target:'Sol'},
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º A çš„éŸ³ç¬¦ã€‚',   target:'A'  },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º Si çš„éŸ³ç¬¦ã€‚',  target:'B'  }, // Si = B
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º D çš„éŸ³ç¬¦ã€‚',   target:'D'  },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º Mi çš„éŸ³ç¬¦ã€‚',  target:'Mi' },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º Fa çš„éŸ³ç¬¦ã€‚',  target:'Fa' },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º La çš„éŸ³ç¬¦ã€‚',  target:'La' },
  { prompt:'è«‹æ‰¾å‡ºä¸‹åˆ—ç‚º C çš„éŸ³ç¬¦ã€‚',   target:'C'  }
];

// æ¯é—œé¡¯ç¤º 8 å¼µå¡ï¼Œå…¶ä¸­æ­£è§£å¼µæ•¸
const CARDS_PER_LEVEL = 8;
const CORRECT_NEEDED   = 3;

/*** ========= å·¥å…· =========== ***/
const $ = sel => document.querySelector(sel);
const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);

function isTarget(asset, target){
  // æ”¯æ´ Solfegeï¼ˆDo Re â€¦ï¼‰èˆ‡è‹±æ–‡ï¼ˆC D â€¦ï¼‰
  return asset.solfege.toLowerCase()===target.toLowerCase()
      || asset.letter.toLowerCase() ===target.toLowerCase();
}

/*** ========= éŸ³è¨Š =========== ***/
const sndCorrect = $('#snd-correct');
const sndWrong   = $('#snd-wrong');
const sndBgm     = $('#snd-bgm');

// Safari/è¡Œå‹•è£ç½®éœ€è¦ä½¿ç”¨è€…äº’å‹•å¾Œæ‰èƒ½æ’­æ”¾
let audioUnlocked = false;
function unlockAudioOnce(){
  if (audioUnlocked) return;
  [sndCorrect,sndWrong,sndBgm].forEach(a=>{
    try { a.muted = true; a.play().then(()=>{a.pause(); a.currentTime=0; a.muted=false;}); } catch(e){}
  });
  audioUnlocked = true;
  // è‹¥ BGM æœ‰é–‹ï¼Œäº’å‹•å¾Œå•Ÿæ’­
  if (state.bgmOn) try{ sndBgm.play(); }catch(e){}
}
document.addEventListener('pointerdown', unlockAudioOnce, { once:true });

/*** ========= æ··éŸ³å™¨ï¼ˆæœƒè¨˜ä½ï¼‰ =========== ***/
const store = {
  get k(){ return 'notegame.settings.v2'; },
  load(){
    try{ return JSON.parse(localStorage.getItem(this.k))||{} }catch(e){return {}}
  },
  save(obj){ localStorage.setItem(this.k, JSON.stringify(obj)); }
};

const state = Object.assign({
  master: 0.8,
  sfxOn:  true,
  wrongOn:true,
  bgmOn:  true,
  volCorrect: 1,
  volWrong:   1,
  volBgm:     0.35
}, store.load());

function applyVolumes(){
  const m = Number(state.master);
  sndCorrect.volume = m * (state.sfxOn ? Number(state.volCorrect):0);
  sndWrong.volume   = m * (state.wrongOn? Number(state.volWrong)  :0);
  sndBgm.volume     = m * (state.bgmOn  ? Number(state.volBgm)    :0);
  if (state.bgmOn && audioUnlocked) sndBgm.play().catch(()=>{});
  if (!state.bgmOn) sndBgm.pause();
}
function bindMixerUI(){
  const vMaster=$('#vol-master'), vC=$('#vol-correct'), vW=$('#vol-wrong'), vB=$('#vol-bgm');
  const tSfx=$('#sfx-toggle'), tWrong=$('#wrong-toggle'), tBgm=$('#bgm-toggle');

  vMaster.value=state.master; vC.value=state.volCorrect; vW.value=state.volWrong; vB.value=state.volBgm;
  tSfx.checked=state.sfxOn; tWrong.checked=state.wrongOn; tBgm.checked=state.bgmOn;

  const onChange=()=>{
    state.master=Number(vMaster.value);
    state.volCorrect=Number(vC.value);
    state.volWrong=Number(vW.value);
    state.volBgm=Number(vB.value);
    state.sfxOn=tSfx.checked; state.wrongOn=tWrong.checked; state.bgmOn=tBgm.checked;
    store.save(state); applyVolumes();
  };
  [vMaster,vC,vW,vB,tSfx,tWrong,tBgm].forEach(el=>el.addEventListener('input',onChange));
  $('#volBtn').addEventListener('click',onChange);
}
bindMixerUI(); applyVolumes();

/*** ========= éŠæˆ²é‚è¼¯ =========== ***/
let levelIndex = 0;
let score = 0;
let found = 0;
let targetsOnBoard = [];

function buildDeck(target){
  // å…ˆæŒ‘å‡ºæ‰€æœ‰ target çš„åœ–ç‰‡
  const targets = ASSETS.filter(a=>isTarget(a,target));
  // ä¸è¶³ 3 å¼µå°±é‡è¤‡æŠ½åˆ° 3
  const need = CORRECT_NEEDED;
  const picksTarget = [];
  while (picksTarget.length < need) {
    picksTarget.push(targets[picksTarget.length % targets.length]);
  }
  // å†è£œè¶³å¹²æ“¾é …
  const others = ASSETS.filter(a=>!isTarget(a,target));
  const distractors = shuffle(others).slice(0, Math.max(0, CARDS_PER_LEVEL - picksTarget.length));
  // å…è¨±å†é‡è¤‡ï¼Œè£œæ»¿åˆ° 8 å¼µ
  while (picksTarget.length + distractors.length < CARDS_PER_LEVEL) {
    distractors.push(others[Math.floor(Math.random()*others.length)]);
  }
  const deck = shuffle([...picksTarget, ...distractors]).map((a,i)=>({
    key:`${a.id}-${i}-${Math.random().toString(36).slice(2,6)}`,
    asset:a,
    isCorrect:isTarget(a,target),
    picked:false
  }));
  // è¨˜ä½æœ¬é—œæ­£è§£æ•¸é‡
  targetsOnBoard = deck.filter(c=>c.isCorrect);
  return deck;
}

function renderLevel(){
  const L = LEVELS[levelIndex];
  $('#q').textContent = 'é¡Œç›®ï¼šã€Œ' + L.prompt + 'ã€';
  $('#stage').textContent = (levelIndex+1) + ' / ' + LEVELS.length;
  $('#score').textContent = score;
  $('#next').disabled = true;
  found = 0;

  const deck = buildDeck(L.target);
  const board = $('#board');
  board.innerHTML = '';
  deck.forEach(card=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.dataset.key = card.key;
    div.innerHTML = `<img alt="" loading="lazy" src="${card.asset.file}"><span class="pill">é»æˆ‘</span>`;
    div.addEventListener('click', ()=>{
      if (card.picked) return;
      card.picked = true;
      if (card.isCorrect){
        div.classList.add('correct');
        score += 10; found++;
        try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch(e){}
        if (found >= targetsOnBoard.length){ $('#next').disabled = false; }
      }else{
        div.classList.add('wrong');
        score = Math.max(0, score - 5);
        try{ sndWrong.currentTime=0; sndWrong.play(); }catch(e){}
      }
      $('#score').textContent = score;
    });
    board.appendChild(div);
  });
}

$('#next').addEventListener('click', ()=>{
  levelIndex++;
  if (levelIndex >= LEVELS.length){
    alert(`æ­å–œé€šé—œï¼ç¸½åˆ†ï¼š${score}`);
    levelIndex = 0; score = 0;
  }
  renderLevel();
});
$('#restart').addEventListener('click', ()=>{
  levelIndex = 0; score = 0; renderLevel();
});

// åˆå§‹è¼‰å…¥
renderLevel();
</script>
</body>
</html>
